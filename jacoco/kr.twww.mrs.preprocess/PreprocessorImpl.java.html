<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreprocessorImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cse364-project</a> &gt; <a href="index.source.html" class="el_package">kr.twww.mrs.preprocess</a> &gt; <span class="el_source">PreprocessorImpl.java</span></div><h1>PreprocessorImpl.java</h1><pre class="source lang-java linenums">package kr.twww.mrs.preprocess;

import kr.twww.mrs.data.DataReader;
import kr.twww.mrs.data.DataReaderImpl;
import kr.twww.mrs.data.object.Movie;
import kr.twww.mrs.data.object.User;
import kr.twww.mrs.preprocess.object.Score;
import kr.twww.mrs.preprocess.predict.Predictor;
import kr.twww.mrs.preprocess.predict.PredictorImpl;
import org.apache.spark.mllib.recommendation.Rating;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

public class PreprocessorImpl extends PreprocessorBase implements Preprocessor
{
    private final DataReader dataReader;

<span class="fc" id="L22">    private final int MAX_PAIR_COUNT = 624000;</span>
<span class="fc" id="L23">    private final int MIN_RATING_COUNT = 10;</span>

    public PreprocessorImpl()
<span class="fc" id="L26">    {</span>
<span class="fc" id="L27">        dataReader = new DataReaderImpl();</span>
<span class="fc" id="L28">    }</span>

    @Override
    public ArrayList&lt;Score&gt; GetRecommendList( String _gender, String _age, String _occupation )
    {
<span class="fc" id="L33">        return GetRecommendList(_gender, _age, _occupation, &quot;&quot;);</span>
    }

    @Override
    public ArrayList&lt;Score&gt; GetRecommendList( String _gender, String _age, String _occupation, String _categories )
    {
<span class="fc" id="L39">        var gender = User.ConvertGender(_gender);</span>
<span class="fc" id="L40">        var age = User.ConvertAge(_age);</span>
<span class="fc" id="L41">        var occupation = User.ConvertOccupationByText(_occupation);</span>
<span class="fc" id="L42">        var categoryList = GetCategoryList(_categories);</span>

<span class="fc" id="L44">        return GetScoreList(</span>
                gender,
                age,
                occupation,
                categoryList
        );
    }

    @Override
    public ArrayList&lt;Movie.Genre&gt; GetCategoryList( String genreText )
    {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        if ( genreText == null ) return null;</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if ( genreText.isEmpty() ) return new ArrayList&lt;&gt;();</span>

<span class="fc" id="L58">        var result = new ArrayList&lt;Movie.Genre&gt;();</span>

<span class="fc" id="L60">        var splitText = genreText.split(&quot;\\|&quot;);</span>

<span class="fc bfc" id="L62" title="All 2 branches covered.">        for ( var i : splitText )</span>
        {
<span class="fc" id="L64">            var genre = Movie.ConvertGenre(i);</span>

<span class="fc bfc" id="L66" title="All 2 branches covered.">            if ( genre == null ) return null;</span>

<span class="fc" id="L68">            result.add(genre);</span>
        }

<span class="fc" id="L71">        return result;</span>
    }

    @Override
    public ArrayList&lt;Score&gt; GetScoreList(
            User.Gender gender,
            User.Age age,
            User.Occupation occupation,
            ArrayList&lt;Movie.Genre&gt; genreList
    )
    {
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if ( gender == null ) return null;</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if ( age == null ) return null;</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if ( occupation == null ) return null;</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if ( genreList == null ) return null;</span>

<span class="fc" id="L87">        System.out.println(&quot;Info: Loading data ... &quot;);</span>

<span class="fc" id="L89">        var userList = dataReader.GetUserList();</span>
<span class="fc" id="L90">        var movieList = dataReader.GetMovieList();</span>
<span class="fc" id="L91">        var ratingList = dataReader.GetRatingList();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">        if ( userList == null ) return null;</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if ( movieList == null ) return null;</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if ( ratingList == null ) return null;</span>

<span class="fc" id="L97">        System.out.println(&quot;Info: Preprocessing ... &quot;);</span>

        // 1. 유저 필터
<span class="fc" id="L100">        var filteredUserList = GetFilteredUserList(</span>
                gender,
                age,
                occupation,
                userList
        );

        // 2. 영화 필터
<span class="fc" id="L108">        var filteredMovieList = GetFilteredMovieList(</span>
                genreList,
                movieList,
                ratingList
        );

        // 3. 유저 최대 N명 선택
<span class="fc" id="L115">        filteredUserList = SelectFilteredUser(</span>
                ratingList,
                filteredUserList,
                filteredMovieList
        );

<span class="fc bfc" id="L121" title="All 2 branches covered.">        if ( filteredUserList == null ) return null;</span>

        // 4. ALS 예측
<span class="fc" id="L124">        var predictList = GetPredictList(</span>
                filteredUserList,
                filteredMovieList,
                ratingList
        );

<span class="fc bfc" id="L130" title="All 2 branches covered.">        if ( predictList == null ) return null;</span>

        // 5. Score 리스트 작성
<span class="fc" id="L133">        var scoreList = ToScoreList(</span>
                filteredMovieList,
                predictList
        );

<span class="fc bfc" id="L138" title="All 2 branches covered.">        if ( scoreList == null ) return null;</span>

        // 6. 내림차순 정렬 및 상위 10개
<span class="fc" id="L141">        scoreList.sort((o1, o2) -&gt; Double.compare(o2.score, o1.score));</span>

<span class="fc" id="L143">        var count = scoreList.size();</span>

<span class="fc bfc" id="L145" title="All 2 branches covered.">        if ( count &gt; 10 )</span>
        {
<span class="fc" id="L147">            count = 10;</span>
        }

<span class="fc" id="L150">        return new ArrayList&lt;&gt;(scoreList.subList(0, count));</span>
    }

    private List&lt;User&gt; GetFilteredUserList(
            User.Gender gender,
            User.Age age,
            User.Occupation occupation,
            List&lt;User&gt; userList
    )
    {
<span class="fc" id="L160">        var unknownCount = 3;</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">        if ( gender == User.Gender.UNKNOWN ) --unknownCount;</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        if ( age == User.Age.UNKNOWN ) --unknownCount;</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if ( occupation == User.Occupation.UNKNOWN ) --unknownCount;</span>

<span class="fc bfc" id="L166" title="All 2 branches covered.">        if ( unknownCount == 0 ) return userList;</span>

<span class="fc" id="L168">        return GetFilteredUserStream(</span>
                gender,
                age,
                occupation,
                userList,
                unknownCount
        );
    }

    private List&lt;User&gt; SelectFilteredUser(
            List&lt;Rating&gt; ratingList,
            List&lt;User&gt; filteredUserList,
            List&lt;Movie&gt; filteredMovieList
    )
    {
<span class="fc bfc" id="L183" title="All 2 branches covered.">        if ( filteredUserList.isEmpty() ) return filteredUserList;</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if ( filteredMovieList.isEmpty() ) return null;</span>

<span class="fc" id="L186">        var size = filteredUserList.size();</span>
<span class="fc" id="L187">        var maxUserCount = MAX_PAIR_COUNT / filteredMovieList.size();</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">        if ( size &lt;= maxUserCount ) return filteredUserList;</span>

<span class="fc" id="L191">        var max = filteredUserList.get(filteredUserList.size() - 1).userId;</span>

<span class="fc" id="L193">        var ratingCount = new int[max + 1];</span>
<span class="fc" id="L194">        Arrays.fill(ratingCount, 0);</span>

<span class="fc" id="L196">        ratingList.forEach(rating -&gt; {</span>
<span class="fc" id="L197">            var userId = rating.user();</span>

<span class="fc bfc" id="L199" title="All 2 branches covered.">            if ( userId &gt; max ) return;</span>

<span class="fc" id="L201">            ++ratingCount[userId];</span>
<span class="fc" id="L202">        });</span>

<span class="fc" id="L204">        filteredUserList.sort(</span>
<span class="fc" id="L205">                Comparator.comparingInt(o -&gt; ratingCount[o.userId])</span>
        );

<span class="fc" id="L208">        return filteredUserList.subList(</span>
<span class="fc" id="L209">                filteredUserList.size() - maxUserCount,</span>
<span class="fc" id="L210">                filteredUserList.size()</span>
        );
    }

    private List&lt;Movie&gt; GetFilteredMovieList(
            List&lt;Movie.Genre&gt; genreList,
            List&lt;Movie&gt; movieList,
            List&lt;Rating&gt; ratingList
    )
    {
<span class="fc bfc" id="L220" title="All 2 branches covered.">        if ( movieList.isEmpty() ) return movieList;</span>

<span class="fc" id="L222">        var max = movieList.get(movieList.size() - 1).movieId;</span>

<span class="fc" id="L224">        var ratingCount = new int[max + 1];</span>
<span class="fc" id="L225">        Arrays.fill(ratingCount, 0);</span>

<span class="fc" id="L227">        ratingList.forEach(rating -&gt; {</span>
<span class="fc" id="L228">            var movieId = rating.product();</span>

<span class="fc bfc" id="L230" title="All 2 branches covered.">            if ( movieId &gt; max ) return;</span>

<span class="fc" id="L232">            ++ratingCount[movieId];</span>
<span class="fc" id="L233">        });</span>

<span class="fc" id="L235">        return movieList</span>
<span class="fc" id="L236">                .stream()</span>
<span class="fc" id="L237">                .filter(movie -&gt; {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">                    if ( ratingCount[movie.movieId] &lt; MIN_RATING_COUNT )</span>
                    {
<span class="fc" id="L240">                        return false;</span>
                    }

<span class="fc bfc" id="L243" title="All 2 branches covered.">                    if ( genreList.isEmpty() ) return true;</span>

<span class="fc" id="L245">                    return genreList</span>
<span class="fc" id="L246">                            .stream()</span>
<span class="fc" id="L247">                            .anyMatch(genre -&gt; movie.genres.contains(genre));</span>
<span class="fc" id="L248">                }).collect(Collectors.toList());</span>
    }

    private List&lt;User&gt; GetFilteredUserStream(
            User.Gender gender,
            User.Age age,
            User.Occupation occupation,
            List&lt;User&gt; userList,
            int unknownCount
    )
    {
<span class="fc" id="L259">        var result = userList</span>
<span class="fc" id="L260">                .stream()</span>
<span class="fc" id="L261">                .filter(user -&gt; {</span>
<span class="fc" id="L262">                    var count = 0;</span>

<span class="fc bfc" id="L264" title="All 2 branches covered.">                    if ( gender != User.Gender.UNKNOWN )</span>
                    {
<span class="fc bfc" id="L266" title="All 2 branches covered.">                        if ( user.gender == gender )</span>
                        {
<span class="fc" id="L268">                            ++count;</span>
                        }
                    }

<span class="fc bfc" id="L272" title="All 2 branches covered.">                    if ( age != User.Age.UNKNOWN )</span>
                    {
<span class="fc bfc" id="L274" title="All 2 branches covered.">                        if ( user.age == age )</span>
                        {
<span class="fc" id="L276">                            ++count;</span>
                        }
                    }

<span class="fc bfc" id="L280" title="All 2 branches covered.">                    if ( occupation != User.Occupation.UNKNOWN )</span>
                    {
<span class="fc bfc" id="L282" title="All 2 branches covered.">                        if ( user.occupation == occupation )</span>
                        {
<span class="fc" id="L284">                            ++count;</span>
                        }
                    }

<span class="fc bfc" id="L288" title="All 2 branches covered.">                    return (count &gt;= unknownCount);</span>
<span class="fc" id="L289">                }).collect(Collectors.toList());</span>

<span class="fc bfc" id="L291" title="All 4 branches covered.">        if ( result.isEmpty() &amp;&amp; (unknownCount &gt; 1) )</span>
        {
<span class="fc" id="L293">            result = GetFilteredUserStream(</span>
                    gender,
                    age,
                    occupation,
                    userList,
                    unknownCount - 1);
        }

<span class="fc" id="L301">        return result;</span>
    }

    private List&lt;Rating&gt; GetPredictList(
            List&lt;User&gt; filteredUserList,
            List&lt;Movie&gt; filteredMovieList,
            ArrayList&lt;Rating&gt; ratingList
    )
    {
<span class="fc" id="L310">        Predictor predictor = new PredictorImpl(dataReader);</span>

<span class="fc bfc" id="L312" title="All 2 branches covered.">        if ( !predictor.LoadModel() )</span>
        {
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if ( !predictor.CreateModel(ratingList) )</span>
            {
<span class="fc" id="L316">                System.out.println(&quot;Error: Create model failed&quot;);</span>

<span class="fc" id="L318">                predictor.Close();</span>
<span class="fc" id="L319">                return null;</span>
            }
        }

<span class="fc" id="L323">        var predictList =</span>
<span class="fc" id="L324">                predictor.GetPredictList(</span>
                        filteredUserList,
                        filteredMovieList
                );

<span class="fc" id="L329">        predictor.Close();</span>

<span class="fc" id="L331">        return predictList;</span>
    }

    private ArrayList&lt;Score&gt; ToScoreList(
            List&lt;Movie&gt; filteredMovieList,
            List&lt;Rating&gt; predictList
    )
    {
<span class="fc bfc" id="L339" title="All 2 branches covered.">        if ( filteredMovieList.isEmpty() ) return null;</span>

<span class="fc" id="L341">        var linkList = dataReader.GetLinkList();</span>

<span class="fc bfc" id="L343" title="All 2 branches covered.">        if ( linkList == null ) return null;</span>

<span class="fc" id="L345">        var max = filteredMovieList.get(filteredMovieList.size() - 1).movieId;</span>

<span class="fc" id="L347">        var scoreFullList = new ArrayList&lt;Score&gt;();</span>
<span class="fc" id="L348">        var scoreList = new ArrayList&lt;Score&gt;();</span>

<span class="fc bfc" id="L350" title="All 2 branches covered.">        for ( var i = 0; i &lt; (max + 1); ++i )</span>
        {
<span class="fc" id="L352">            scoreFullList.add(new Score());</span>
        }

<span class="fc" id="L355">        filteredMovieList.forEach(</span>
<span class="fc" id="L356">                movie -&gt; scoreFullList.get(movie.movieId).movie = movie</span>
        );

<span class="fc" id="L359">        predictList.forEach(</span>
<span class="fc" id="L360">                rating -&gt; scoreFullList.get(rating.product()).score += rating.rating()</span>
        );

<span class="fc" id="L363">        linkList.forEach(link -&gt; {</span>
<span class="fc" id="L364">            var movieId = link.movieId;</span>

<span class="fc bfc" id="L366" title="All 2 branches covered.">            if ( movieId &gt; max ) return;</span>

<span class="fc" id="L368">            scoreFullList.get(movieId).link = link;</span>

<span class="fc" id="L370">            scoreList.add(scoreFullList.get(movieId));</span>
<span class="fc" id="L371">        });</span>

<span class="fc" id="L373">        return scoreList;</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>